# Lv4（背理法）実装方針

## 概要

Lv1〜3で解けないセルに対して、背理法による推論を行う。
仮置き→Lv1推論を繰り返し、矛盾が発生すれば確定とする。

---

## 設計方針

- **案C（軽量ソルバー）を採用**
- 本体の`regionPool`には触れない
- Regionオブジェクトを生成せず、一時盤面を直接操作
- まずLv1のみで矛盾検出し、検出漏れが問題になればLv2/Lv3を追加

---

## 処理フロー

### solveLv4()

```
1. 未確定セル（board[i] == MINE）をリストアップ

2. 各セルについて:
    a. completeBoardで正解を確認
    b. 逆の値を決定:
        - 正解がMINE → SAFEと仮置き
        - 正解がSAFE → FLAGGEDと仮置き
    c. 一時盤面を作成し仮置きを適用
    d. testContradiction()で矛盾判定
    e. 矛盾あり → そのセルを正解で確定、return（Lv1に戻る）
    f. 矛盾なし → 次のセルへ

3. 全セル試しても確定できなければ空を返す（Lv4でも解けない）
```

### testContradiction(int[] tempBoard)

```
while true:
    changed = false
    
    for each ヒントセル (tempBoard[i] >= 0):
        
        [隣接セルの集計]
        - unknownCells: 隣接する未確定セル（MINE）のリスト
        - flaggedCount: 隣接するFLAGGEDの数
        - remainingMines = tempBoard[i] - flaggedCount
        
        [スキップ判定]
        - if unknownCells.isEmpty() → このヒントをスキップ
        
        [矛盾チェック]
        - if remainingMines < 0 → return true（矛盾：地雷多すぎ）
        - if remainingMines > unknownCells.size() → return true（矛盾：置く場所足りない）
        
        [確定処理]
        - if remainingMines == 0:
            全unknownCellsをSAFEに（tempBoard直接書き換え）
            changed = true
        - if remainingMines == unknownCells.size():
            全unknownCellsをFLAGGEDに（tempBoard直接書き換え）
            changed = true
    
    if not changed → break

return false（矛盾なし）
```

---

## 矛盾検出の条件

| 条件                                   | 意味                     | 例                         |
| -------------------------------------- | ------------------------ | -------------------------- |
| `remainingMines < 0`                   | 地雷が多すぎる           | ヒント2に対しフラグ3つ     |
| `remainingMines > unknownCells.size()` | 地雷を置く場所が足りない | 残り地雷2に対し未確定1セル |

---

## 仮置き時の値

| 正解 | 仮置きする値 |
| ---- | ------------ |
| MINE | SAFE         |
| SAFE | FLAGGED      |

※ SAFEと仮置きする際、ヒント数字はセットしない（SAFEのまま）

---

## 本体との分離

| 観点       | 本体（Lv1〜3）             | testContradiction  |
| ---------- | -------------------------- | ------------------ |
| データ構造 | Regionオブジェクト         | ローカル変数のみ   |
| 盤面       | `board`フィールド          | `tempBoard`引数    |
| 結果格納   | `deduced` Map              | 盤面直接書き換え   |
| 目的       | 確定セルの収集と難易度記録 | 矛盾の有無のみ判定 |

---

## 確定できないケース

仮置き後のLv1推論で：
- 矛盾が発生しない
- かつ、これ以上確定できるセルもない

→ そのセルはLv4では確定できない
→ 次の未確定セルへ進む

---

## 今後の拡張

Lv1のみで検出漏れが多い場合：
- testContradiction内にLv2/Lv3の推論を追加
- または案Aに切り替え（RegionPoolのコピー）