マインスイーパ難易度解析機能 設計書

1. 概要

本機能は、マインスイーパの盤面において、各空白セルを論理的に確定させるために必要な「ヒントの数（思考コスト）」を算出するものです。
プレイヤーがパズルを解く際の「手筋の複雑さ」を数値化し、パズルの難易度判定や解析に使用します。

2. 基本方針

最小コストの算出: あるセルを確定させるために、最低いくつのヒントを同時に参照する必要があるか（$k$）を求めます。

段階的探索: 簡単な手筋（$k=1$）から順に、複雑な手筋（$k=2, 3...$）へと探索範囲を広げます。

不可逆進行: ある段階（例: $k=3$）でセルが解けたとしても、探索レベルを $k=1$ に戻すことはせず、そのまま次の段階へ進みます（「そのセルを解くには $k=3$ の思考が必要だった」という事実を優先するため）。

独立した推論: 同一ラウンド内での推論は互いに独立しており、連鎖的な確定（あるセルが解けたから隣も解ける等）はラウンド更新時にまとめて処理します。

3. 定数と状態管理

盤面の各セルは以下の4つの状態を持ち、厳密に区別して管理します。

状態名

値

意味

役割・制約

UNKNOWN

-1

未確定

推論対象の変数（0または1）。

HINT

0～8

ヒント数字

制約の基準となる数値。

FLAGGED

-3

地雷確定

**定数(1)**として扱う。隣接する HINT の数値を減算する効果を持つ。

IGNORE

-2

無視

計算対象外。制約行列に含めない。

4. アルゴリズム詳細

4.1. メインプロセス (calculate)

初期化:

解析用盤面 (currentBoard) を作成。

初期状態で開示されているヒントセルは、難易度 0 として記録。

レベル探索ループ:

探索するヒント集合のサイズ $k$ を $1$ から最大値（例: 8）までインクリメントしながらループする。

全セルが解決済みになれば早期終了。

各 $k$ について ラウンド処理 (executeRound) を実行する。

4.2. ラウンド処理 (executeRound)

指定されたヒント数 $k$ における全探索を行い、確定した情報を一括で反映します。

ヒント収集: 現在の盤面上の HINT セルをすべてリストアップする。

組み合わせ生成: $k$ 個のヒントを選ぶ組み合わせ（部分集合）を全列挙する。

推論実行 (Batch Logic):

このラウンドで確定したセルを一時的に保存するセット (roundSolved) を用意。

各部分集合について以下を実行：

有効性チェック: 部分集合の周囲に UNKNOWN セルが1つもなければスキップ。

局所解析: tryDeduce を実行し、確定したセルがあれば roundSolved に追加。

注: この時点では盤面を更新しない。

盤面更新:

roundSolved に含まれるセルについて、正解盤面 (completeBoard) を参照して更新。

安全: 数字を公開し、新たな HINT とする。

地雷: FLAGGED (-3) に変更する。

結果用配列 (difficultyMap) に現在の $k$ を記録する。

4.3. 局所解析 (tryDeduce)

特定のヒント部分集合だけに着目した推論を行います。

一時盤面の作成: 現在の盤面のコピーを作成。

ノイズ除去 (マスキング):

選ばれた部分集合に含まれない HINT → IGNORE に変更。

選ばれた部分集合の周囲8マス以外にある UNKNOWN → IGNORE に変更。

注: FLAGGED はそのまま残す。

DLXソルバ実行:

ConstraintBuilder に一時盤面を渡し、制約充足問題を解く。

解の検証:

得られた解（全解で共通する確定事項）を正解盤面と照合。

正しく推論できているセルのみを「確定」として返す。

5. 外部クラス連携仕様

5.1. ConstraintBuilder

盤面配列をDLX用の行列に変換するクラス。以下の仕様で HintCountCalculator をサポートします。

入力: IGNORE や FLAGGED を含む盤面配列。

IGNORE処理: 値が -2 のセルは、変数リスト・ヒントリストのいずれにも含めない。

FLAGGED処理:

HINT セルの制約生成時、周囲に FLAGGED (-3) が存在する場合、その数だけヒント数値を減算する（例: ヒント3の隣に旗が1つあれば、残り地雷数2として制約を作る）。

FLAGGED 自体は変数として扱わない（定数化）。

5.2. DancingLinks (DLX)

入力: ConstraintBuilder が生成した疎行列。

出力: 制約を満たす行（セル状態）のリスト。